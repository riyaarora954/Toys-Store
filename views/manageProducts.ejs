<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include("./pages/headerfiles") %>
    <title>Products</title>
  </head>
  <body onload="getCategories()">
    <%- include("./pages/adminNavbar.ejs") %>
    <div class="modal" tabindex="-1" role="dialog" id="editProductModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Product</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editProductsForm">
              <input type="hidden" id="eproductId" name="product_id" />

              <div class="row mt-3">
                <div class="col-sm-12">
                  <label for="eproductName">Product Name:</label>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <input
                    type="text"
                    name="productName"
                    id="eproductName"
                    class="form-control"
                    required
                  />
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <label for="edescription">Description:</label>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <textarea
                    name="description"
                    id="edescription"
                    class="form-control"
                    required
                  ></textarea>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <label for="eprice">Price:</label>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <input
                    type="number"
                    name="price"
                    id="eprice"
                    class="form-control"
                    onkeyup="eNetPrice()"
                    required
                  />
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <label for="ediscount">Discount:</label>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <input
                    type="number"
                    name="discount"
                    id="ediscount"
                    class="form-control"
                    onkeyup="eNetPrice()"
                    required
                  />
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <label for="enetPrice">Net Price:</label>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <input
                    type="number"
                    name="enetPrice"
                    id="enetPrice"
                    class="form-control"
                    required
                  />
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <label for="ephoto">Photo:</label>
                </div>
              </div>
              <img id="ephoto" height="50" width="50" />
              <div class="row mt-3">
                <div class="col-sm-12">
                  <input
                    type="file"
                    name="photo"
                    class="form-control"
                    accept="image/*"
                  />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary mt-3"
              onclick="updateProduct()"
            >
              Add
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <section id="wrapper">
      <div class="container">
        <div class="row">
          <div id="content-wrapper" class="col-12">
            <section id="main">
              <div class="login-page">
                <div class="block-title">
                  <h2 class="title"><span>Add Products</span></h2>
                </div>
                <form id="addProductsForm">
                  <input type="hidden" id="productId" name="product_id" />
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="categories">Select Category:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <select
                        name="categories"
                        id="categories"
                        class="form-control"
                        required
                      ></select>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="productName">Product Name:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <input
                        type="text"
                        name="productName"
                        id="productName"
                        class="form-control"
                        required
                      />
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="description">Description:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <textarea
                        name="description"
                        id="description"
                        class="form-control"
                        required
                      ></textarea>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="price">Price:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <input
                        type="number"
                        name="price"
                        id="price"
                        class="form-control"
                        onkeyup="NetPrice()"
                        required
                      />
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="discount">Discount:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <input
                        type="number"
                        name="discount"
                        id="discount"
                        class="form-control"
                        onkeyup="NetPrice()"
                        required
                      />
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="netPrice">Net Price:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <input
                        type="number"
                        name="netPrice"
                        id="netPrice"
                        class="form-control"
                        required
                      />
                    </div>
                  </div>

                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="photo">Photo:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <input
                        type="file"
                        name="photo"
                        class="form-control"
                        accept="image/*"
                      />
                    </div>
                  </div>
                  <div class="text-center">
                    <button
                      type="button"
                      class="btn btn-primary mt-3"
                      onclick="addProduct()"
                    >
                      Add
                    </button>
                  </div>
                </form>
                <div id="dataResult" class="mt-5"></div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>

    <%-include('./pages/scriptfiles')%>

    <script>
      let addProduct = () => {
        $("#addProductsForm").validate();
        if ($("#addProductsForm").valid()) {
          let form = document.getElementById("addProductsForm");
          let fd = new FormData(form);
          fetch("/admin/saveProduct", { method: "POST", body: fd })
            .then((res) => res.json())
            .then((res) => {
              if (res.error) {
                Swal.fire({
                  icon: "error",
                  title: res.message,
                });
              } else {
                Swal.fire({
                  icon: "success",
                  title: res.message,
                  timer: 1500,
                }).then(() => {
                  document.getElementById("addProductsForm").reset();
                });
                viewProducts();
              }
            });
        }
      };

      let getCategories = () => {
        fetch("/admin/getCategories")
          .then((res) => res.json())
          .then((res) => {
            if (!res.error) {
              let data = res.records;
              let results = `<option value="">Select</option>`;
              data.forEach((item) => {
                results += `<option value="${item.category_id}">${item.category_name}</option>`;
              });
              document.getElementById("categories").innerHTML = results;
              viewProducts();
            }
          });
      };

      let NetPrice = () => {
        let price = parseInt(document.getElementById("price").value);
        let discount = parseInt(document.getElementById("discount").value);
        let netPrice = price - (price * discount) / 100;
        document.getElementById("netPrice").value = netPrice;
      };

      let viewProducts = () => {
        fetch("/admin/viewProducts")
          .then((res) => res.json())
          .then((res) => {
            if (res.error === false) {
              let ans = `<table class='table'>
      <thead>
      <tr class="text-center">
      <th>Sr.No.</th>
      <th>Product id</th>
      <th>Category Name</th>
      <th>Product Name</th>
      <th>Description</th>
      <th>Price</th>
      <th>Discount</th>
      <th>Net Price</th>
      <th>Photo</th>
      <th colspan="2">Action</th>
      </tr>
      </thead>`;
              let records = res.records;
              console.log(records);
              if (records.length > 0) {
                records.forEach((data, index) => {
                  ans += `<tr class="text-center">
      <td>${index + 1}</td>
      <td>${data.product_id}</td>
      <td>${data.category_name}</td>
      <td>${data.name}</td>
      <td>${data.description}</td>
      <td>${data.price}</td>
      <td>${data.discount}</td>
      <td>${data.net_price}</td>
      <td><img src="${data.photo}" height='100' width='100'/></td>
      <td><button type="button" class="btn btn-warning" onclick="editProduct('${
        data.product_id
      }')" >
      <i class="fa-solid fa-pencil"></i></button>
        <button type="button" class="btn btn-danger" onclick="delProduct('${
          data.product_id
        }')"><i class="fa-solid fa-trash"></i></button></td>
      </tr>`;
                });
              } else {
                ans += `<tr class="text-center">
                        <td colspan="6"> <div class="alert alert-danger">No data found</div></td></tr>`;
              }

              ans += `</table>`;
              document.getElementById("dataResult").innerHTML = ans;
            }
          });
      };
      let delProduct = (product_id) => {
        Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, delete it!",
        }).then((result) => {
          if (result.isConfirmed) {
            fetch("/admin/delProduct/" + product_id)
              .then((res) => res.json())
              .then((res) => {
                console.log(res);
                if (res.error === true) {
                  swal.fire({
                    icon: "error",
                    title: res.message,
                  });
                } else {
                  swal.fire({
                    icon: "success",
                    title: res.message,
                    timer: 1500,
                  });
                  viewProducts();
                }
              });
          }
        });
      };
      let eNetPrice = () => {
        let price = parseInt(document.getElementById("eprice").value);
        let discount = parseInt(document.getElementById("ediscount").value);
        let netPrice = price - (price * discount) / 100;
        document.getElementById("enetPrice").value = netPrice;
      };
      let editProduct = (product_id) => {
        console.log(product_id);

        $("#editProductModal").modal("show");
        fetch("/admin/getProduct/" + product_id)
          .then((res) => res.json())
          .then((res) => {
            console.log(res.message);
            if (res.error === false) {
              console.log(res.records);
              document.getElementById("eproductId").value =
                res.records.product_id;
              document.getElementById("eproductName").value = res.records.name;
              document.getElementById("edescription").value =
                res.records.description;
              document.getElementById("ediscount").value = res.records.discount;

              document.getElementById("eprice").value = res.records.price;
              document.getElementById("enetPrice").value =
                res.records.net_price;

              document.getElementById("ephoto").src = res.records.photo;
            } else {
              console.log("Error message:", res.message);
            }
          })
          .catch((error) => {
            console.error("Fetch error:", error);
          });
      };
      let updateProduct = () => {
        let form = document.getElementById("editProductsForm");
        let fd = new FormData(form);
        fetch("/admin/updateProduct", {
          method: "POST",
          body: fd,
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.error === false) {
              viewProducts();
              $("#editProductModal").modal("hide");
            }
          });
      };
    </script>
  </body>
</html>
