<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include("./pages/headerfiles") %>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <title>Document</title>
  </head>
  <body onload="viewCategories()">
    <%- include("./pages/adminNavbar.ejs") %>
    <div class="modal" tabindex="-1" role="dialog" id="editCategoryModal">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Category</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editCategoriesForm">
              <input type="hidden" id="ecategoryId" name="category_id" />
              <div class="row mt-3">
                <div class="col-sm-12">
                  <label for="ecategoryName">Category Name:</label>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <input
                    type="text"
                    name="categoryName"
                    id="ecategoryName"
                    class="form-control"
                    required
                  />
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <label for="edescription">Description:</label>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <textarea
                    rows="4"
                    name="description"
                    id="edescription"
                    class="form-control"
                    required
                  ></textarea>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-sm-12">
                  <label for="ephoto">Photo:</label>
                </div>
              </div>
              <img id="ephoto" height="50" width="50" />
              <div class="row mt-3">
                <div class="col-sm-12">
                  <input
                    type="file"
                    name="photo"
                    class="form-control"
                    accept="image/*"
                  />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary mt-3"
              onclick="updateCategory()"
            >
              Update
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <section id="wrapper">
      <div class="container">
        <div class="row">
          <div id="content-wrapper" class="col-12">
            <section id="main">
              <div class="login-page">
                <div class="block-title">
                  <h2 class="title"><span>Add Categories</span></h2>
                </div>
                <form id="addCategoriesForm">
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="categoryName">Category Name:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <input
                        type="text"
                        name="categoryName"
                        id="categoryName"
                        class="form-control"
                        required
                      />
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="description">Description:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <textarea
                        name="description"
                        id="description"
                        class="form-control"
                        required
                      ></textarea>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <label for="photo">Photo:</label>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12">
                      <input
                        type="file"
                        name="photo"
                        id="photo"
                        class="form-control"
                        accept="image/*"
                        required
                      />
                    </div>
                  </div>
                  <div class="text-center">
                    <button
                      type="button"
                      class="btn btn-primary mt-3"
                      onclick="addCategory()"
                    >
                      Add
                    </button>
                  </div>
                </form>
                <div id="dataResult" class="mt-5"></div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>

    <%-include('./pages/scriptfiles')%>

    <script>
      let addCategory = () => {
        $("#addCategoriesForm").validate();
        if ($("#addCategoriesForm").valid()) {
          let form = document.getElementById("addCategoriesForm");
          let fd = new FormData(form);
          fetch("/admin/saveCategory", { method: "POST", body: fd })
            .then((res) => res.json())
            .then((res) => {
              if (res.error) {
                Swal.fire({
                  icon: "error",
                  title: res.message,
                });
              } else {
                Swal.fire({
                  icon: "success",
                  title: res.message,
                  timer: 1500,
                }).then(() => {
                  document.getElementById("addCategoriesForm").reset();
                });
              }
            });
        }
      };

      let viewCategories = () => {
        fetch("/admin/viewCategories")
          .then((res) => res.json())
          .then((res) => {
            if (res.error === false) {
              let ans = `<table class='table'>
      <thead>
      <tr class="text-center">
      <th>Sr.No</th>
      <th>Category Id</th>
      <th>Name</th>
      <th>Description</th>
      <th>Photo</th>
      <th colspan="2">Action</th>
      </tr>
      </thead>`;
              let records = res.records;
              if (records.length > 0) {
                records.forEach((data, index) => {
                  ans += `<tr class="text-center">
      <td>${index + 1}</td>
      <td>${data.category_id}</td>
      <td>${data.category_name}</td>
      <td>${data.description}</td>
      <td><img src="${data.photo}" height='100' width='100'/></td>
      <td><button type="button" class="btn btn-warning" onclick="editCategory('${
        data.category_id
      }')">
      <i class="fa-solid fa-pencil"></i></button>
        <button type="button" class="btn btn-danger" onclick="delCategory('${
          data.category_id
        }')"><i class="fa-solid fa-trash"></i></button></td>
      </tr>`;
                });
              } else {
                ans += `<tr class="text-center">
                        <td colspan="6"> <div class="alert alert-danger">No data found</div></td></tr>`;
              }

              ans += `</table>`;
              document.getElementById("dataResult").innerHTML = ans;
            }
          });
      };
      let editCategory = (category_id) => {
        $("#editCategoryModal").modal("show");
        fetch("/admin/getCategory/" + category_id)
          .then((res) => res.json())
          .then((res) => {
            console.log("Response message:", res.message);
            if (res.error === false) {
              console.log("Fetched records:", res.records);
              document.getElementById("ecategoryId").value =
                res.records.category_id;
              document.getElementById("ecategoryName").value =
                res.records.category_name;
              document.getElementById("edescription").value =
                res.records.description;
              document.getElementById("ephoto").src = "/" + res.records.photo;
            } else {
              console.log("Error message:", res.message);
            }
          })
          .catch((error) => {
            console.error("Fetch error:", error);
          });
      };
      let delCategory = (category_id) => {
        Swal.fire({
          title: "Are you sure?",
          text: "You won't be able to revert this!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes, delete it!",
        }).then((result) => {
          if (result.isConfirmed) {
            fetch("/admin/delCategory/" + category_id)
              .then((res) => res.json())
              .then((res) => {
                console.log(res);
                if (res.error === true) {
                  swal.fire({
                    icon: "error",
                    title: res.message,
                  });
                } else {
                  swal.fire({
                    icon: "success",
                    title: res.message,
                    timer: 1500,
                  });
                  viewCategories();
                }
              });
          }
        });
      };
      let updateCategory = () => {
        let form = document.getElementById("editCategoriesForm");
        let fd = new FormData(form);
        fetch("/admin/updateCategory", {
          method: "POST",
          body: fd,
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.error === false) {
              viewCategories();
              $("#editCategoryModal").modal("hide");
            }
          });
      };
    </script>
  </body>
</html>
